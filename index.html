<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NILE - Follow the trend</title>
    <script data-memberstack-app="app_cml9gnmyh02sc0stj77wr8xma" src="https://static.memberstack.com/scripts/v2/memberstack.js" type="text/javascript"></script>
    
    <style>
        body, html { margin: 0; padding: 0; min-height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #131722; color: #e0e0e0; }
        
        /* Nascondiamo tutto all'inizio per evitare confusione */
        #login-screen, #dashboard-screen { display: none; }

        /* SCHERMATA LOGIN */
        .login-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at center, #1e222d 0%, #131722 100%);
        }
        .login-box {
            text-align: center;
            padding: 40px;
            background: #1e222d;
            border: 1px solid #2a2e39;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            max-width: 400px;
            width: 90%;
        }
        .login-box h1 { color: #2962ff; margin-bottom: 10px; font-size: 32px; letter-spacing: 2px; }
        
        /* DASHBOARD */
        .dashboard-screen { padding: 20px; }
        .data-section { max-width: 1600px; margin: 0 auto; background-color: #1e222d; border-radius: 12px; border: 1px solid #2a2e39; overflow: hidden; }
        .header-panel { padding: 20px; border-bottom: 1px solid #2a2e39; background: #1e222d; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px; }
        
        .ms-btn { background: #2962ff; color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: bold; font-size: 14px; cursor: pointer; border: none; }
        .btn-outline { background: transparent; border: 1px solid #3d4151; color: #b2b5be; }

        /* BANNER UPGRADE */
        .upgrade-banner { background: #2962ff; color: #fff; text-align: center; padding: 10px; font-weight: bold; display: none; }

        /* TABELLA E STATISTICHE */
        .signal-stats { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px; }
        .stat-box { font-weight: bold; font-size: 13px; padding: 8px 15px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); }
        .buy-stat { color: #00ff00; background: rgba(0, 255, 0, 0.1); }
        .sell-stat { color: #ff4444; background: rgba(255, 68, 68, 0.1); }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #2a2e39; color: #b2b5be; padding: 15px 12px; text-align: left; font-size: 11px; }
        td { padding: 12px 12px; border-bottom: 1px solid #2a2e39; }
        .ticker-style { font-weight: bold; color: #2962ff; }
        
        .filter-input { width: 100%; background: #131722; border: 1px solid #3d4151; color: #fff; padding: 6px; border-radius: 4px; }
        .star-icon { cursor: pointer; color: #3d4151; font-size: 18px; }
        .star-icon.active { color: #ffca28; }
    </style>
</head>
<body>

    <div id="login-screen" class="login-screen">
        <div class="login-box">
            <h1>NILE</h1>
            <p>Institutional Trend Follower System</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button data-ms-modal="login" class="ms-btn">Log In</button>
                <button data-ms-modal="signup" class="ms-btn btn-outline">Sign Up</button>
            </div>
        </div>
    </div>

    <div id="dashboard-screen" class="dashboard-screen">
        <div class="data-section">
            <div id="upgrade-banner" class="upgrade-banner">
                PASS TO PREMIUM TO UNLOCK ALL DATA
            </div>

            <div class="header-panel">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <h2>NILE - Follow the trend</h2>
                        <button data-ms-action="logout" class="ms-btn btn-outline" style="padding: 8px 15px; font-size: 12px;">Log Out</button>
                    </div>
                    <div class="signal-stats">
                        <div id="buyCounter" class="stat-box buy-stat">BUY SIGNAL W: 0</div>
                        <div id="sellCounter" class="stat-box sell-stat">SELL SIGNAL W: 0</div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="color: #4caf50; font-weight: bold;">● AUTO-UPDATE ACTIVE</div>
                    <div style="font-size: 12px; color: #8d92a3; margin-top: 5px;">
                        User: <span data-ms-member="email">loading...</span>
                    </div>
                </div>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Ticker</th><th>Market</th><th>Sector</th><th>Industry</th><th>Last Price</th><th>Trend W</th>
                            <th>Price Flip W</th><th>Var % W</th><th>Trend D</th><th>Price Flip D</th><th>Var % D</th><th>★</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
                <div id="limit-msg" style="display:none; padding: 20px; text-align: center; color: #8d92a3; border-top: 1px solid #2a2e39;">
                    — Showing only 5 rows (Free Plan) —
                </div>
            </div>
        </div>
    </div>

<script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQdzNpQjqwdqK5ZO16Kd8hlNNtmm31gxOy1AAb49CDXqxMwEOmUpowc9H4rHWPbb9rd874zmOtcDTUo/pub?gid=1410987574&single=true&output=csv';

    // Funzione principale di caricamento dati
    async function loadData(isPremium) {
        try {
            const res = await fetch(csvUrl + '&nocache=' + Date.now());
            const text = await res.text();
            const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const maxRows = isPremium ? 9999 : 5;
            if (!isPremium) document.getElementById('limit-msg').style.display = 'block';
            else document.getElementById('limit-msg').style.display = 'none';

            let buys = 0, sells = 0;

            for (let i = 1; i < lines.length; i++) {
                if (i > maxRows) break;
                const c = lines[i].split(text.includes(';') ? ';' : ',');
                if (c.length < 5) continue;

                const trendW = c[4] || "";
                if (trendW.toUpperCase().includes("BUY")) buys++;
                if (trendW.toUpperCase().includes("SELL")) sells++;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="ticker-style">${c[0]}</td><td>${c[1]}</td><td>${c[17]}</td><td>${c[18]}</td>
                    <td style="color:#fff">${c[14]}</td>
                    <td>${trendW.includes("BUY") ? '<span style="color:#0f0">BUY</span>' : '<span style="color:#f44">SELL</span>'}</td>
                    <td>${c[6]}</td><td>${c[15]}</td><td>${c[9]}</td><td>${c[11]}</td><td>${c[16]}</td><td>★</td>
                `;
                tbody.appendChild(tr);
            }
            document.getElementById('buyCounter').innerText = "BUY SIGNAL W: " + buys;
            document.getElementById('sellCounter').innerText = "SELL SIGNAL W: " + sells;
        } catch (e) { console.error("Errore CSV:", e); }
    }

    // Gestione Accesso Memberstack
    window.addEventListener('load', async () => {
        const memberstack = window.$memberstackDom;
        
        // Aspetta che Memberstack sia pronto
        setTimeout(async () => {
            const { data: member } = await memberstack.getCurrentMember();

            if (!member) {
                // UTENTE NON LOGGATO -> Mostra Login
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('dashboard-screen').style.display = 'none';
            } else {
                // UTENTE LOGGATO -> Mostra Dashboard
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard-screen').style.display = 'block';
                
                // Controlla se ha il piano Premium
                const isPremium = member.planConnections && member.planConnections.some(pc => pc.planId === "premium" || pc.planId.startsWith("pln_"));
                
                if (!isPremium) document.getElementById('upgrade-banner').style.display = 'block';
                
                loadData(isPremium);
            }
        }, 1000);
    });
</script>
</body>
</html>
