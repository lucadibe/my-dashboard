<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NILE - Industry Statistics</title>
    <script data-memberstack-app="app_cmlf9re4g00u40ss19rl32mj9" src="https://static.memberstack.com/scripts/v2/memberstack.js" type="text/javascript"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #1e293b; padding-bottom: 20px; position: relative; }
        .brand-title { font-size: 1.8rem; font-weight: 900; color: #38bdf8; text-transform: uppercase; letter-spacing: 2px; position: absolute; left: 50%; transform: translateX(-50%); }
        
        .back-btn { background: transparent; border: 1px solid #334155; color: #94a3b8; padding: 8px 15px; border-radius: 6px; cursor: pointer; text-decoration: none; font-size: 0.9rem; transition: 0.3s; }
        .back-btn:hover { border-color: #38bdf8; color: #38bdf8; }

        /* Stile Intestazioni Sezioni */
        .section-title { 
            font-size: 1.5rem; 
            font-weight: 800; 
            color: #38bdf8; 
            margin: 40px 0 20px 0; 
            padding-left: 10px; 
            border-left: 4px solid #38bdf8;
            text-transform: uppercase;
        }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(450px, 1fr)); gap: 20px; margin-bottom: 50px; }
        .industry-card { background: #1e293b; padding: 20px; border-radius: 12px; border: 1px solid #334155; display: flex; flex-direction: column; gap: 10px; }
        .industry-name { font-weight: 800; font-size: 1.1rem; color: #f8fafc; border-bottom: 1px solid #334155; padding-bottom: 8px; }
        
        .stat-row { display: flex; justify-content: space-between; align-items: center; font-family: 'Courier New', monospace; font-size: 1rem; }
        .buy-label { color: #4ade80; font-weight: bold; }
        .sell-label { color: #f87171; font-weight: bold; }
        
        .progress-bar-bg { background: #0f172a; height: 10px; border-radius: 5px; overflow: hidden; display: flex; margin-top: 5px; }
        .progress-buy { background: #166534; height: 100%; }
        .progress-sell { background: #7f1d1d; height: 100%; }
        
        @media (max-width: 768px) { .brand-title { display: none; } .stats-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="header">
        <a href="dashboard.html" class="back-btn">‚Üê BACK TO DASHBOARD</a>
        <div class="brand-title">INDUSTRY ANALYTICS</div>
        <div style="width: 150px;"></div> 
    </div>

    <div id="loading" style="text-align: center; margin-top: 50px;">Calculating industry trends...</div>

    <div id="stocksSection" style="display: none;">
        <div class="section-title">Stock Markets</div>
        <div class="stats-grid" id="stocksGrid"></div>
    </div>

    <div id="cryptoSection" style="display: none;">
        <div class="section-title">Cryptocurrencies</div>
        <div class="stats-grid" id="cryptoGrid"></div>
    </div>

    <script>
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQdzNpQjqwdqK5ZO16Kd8hlNNtmm31gxOy1AAb49CDXqxMwEOmUpowc9H4rHWPbb9rd874zmOtcDTUo/pub?gid=1410987574&single=true&output=csv';

        async function loadIndustryStats() {
            try {
                const res = await fetch(csvUrl + '&nocache=' + Date.now());
                const text = await res.text();
                const sep = text.includes(';') ? ';' : ',';
                const lines = text.split(/\r?\n/);
                
                const stocks = {};
                const cryptos = {};

                lines.forEach((line, index) => {
                    if (index === 0 || !line) return;
                    const c = parseCSVLine(line, sep);
                    
                    const marketVal = (c[1] || "").toUpperCase();
                    const industryVal = (c[18] || "").toUpperCase();

                    // FILTRO ESCLUSIONE
                    const excluded = ['ASIA', 'CURRENCY RATES', 'EUROPE', 'USA', 'URANIUM'];
                    if (excluded.includes(marketVal) || excluded.includes(industryVal)) return;

                    const industry = c[18] || "Other / Unknown";
                    const trendW = (c[4] || "").toUpperCase();

                    // Divisione per tipologia di mercato
                    const targetObj = marketVal.includes("CRYPTOCURRENCIES") ? cryptos : stocks;

                    if (!targetObj[industry]) {
                        targetObj[industry] = { buy: 0, sell: 0, total: 0 };
                    }

                    targetObj[industry].total++;
                    if (trendW.includes("BUY")) targetObj[industry].buy++;
                    if (trendW.includes("SELL")) targetObj[industry].sell++;
                });

                renderStats(stocks, 'stocksGrid', 'stocksSection');
                renderStats(cryptos, 'cryptoGrid', 'cryptoSection');
                
                document.getElementById('loading').style.display = 'none';

            } catch (e) { console.error(e); }
        }

        function renderStats(data, gridId, sectionId) {
            const grid = document.getElementById(gridId);
            const section = document.getElementById(sectionId);
            
            const names = Object.keys(data).sort();
            if (names.length === 0) return;

            section.style.display = 'block';
            grid.innerHTML = '';

            names.forEach(name => {
                const stat = data[name];
                const buyPct = Math.round((stat.buy / stat.total) * 100);
                const sellPct = 100 - buyPct;

                const card = document.createElement('div');
                card.className = 'industry-card';
                card.innerHTML = `
                    <div class="industry-name">${name}</div>
                    <div class="stat-row">
                        <span><span class="buy-label">${buyPct}%</span> üü¢BUY</span>
                        <span><span class="sell-label">${sellPct}%</span> üî¥SELL</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-buy" style="width: ${buyPct}%"></div>
                        <div class="progress-sell" style="width: ${sellPct}%"></div>
                    </div>
                    <div style="font-size: 0.7rem; color: #475569; text-align: right;">Based on ${stat.total} assets</div>
                `;
                grid.appendChild(card);
            });
        }

        function parseCSVLine(l, s) {
            const r = []; let cur = '', q = false;
            for (let char of l) { if (char === '"') q = !q; else if (char === s && !q) { r.push(cur.trim()); cur = ''; } else cur += char; }
            r.push(cur.trim()); return r;
        }

        window.addEventListener('load', () => {
            window.$memberstackDom.getCurrentMember().then(({data}) => {
                if (data) loadIndustryStats(); else window.location.href = "index.html";
            });
        });
    </script>
</body>
</html>
