<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Moneyline Dashboard - Pure Data</title>
    <style>
        body { margin: 0; padding: 20px; background-color: #131722; font-family: 'Segoe UI', sans-serif; color: #e0e0e0; }
        .data-section { max-width: 1200px; margin: 0 auto; background-color: #1e222d; border-radius: 8px; border: 1px solid #2a2e39; overflow: hidden; }
        .header-panel { padding: 15px 20px; border-bottom: 1px solid #2a2e39; background: #1e222d; display: flex; justify-content: space-between; align-items: center; }
        h2 { margin: 0; font-size: 18px; color: #d1d4dc; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; text-align: left; }
        th { position: sticky; top: 0; background: #2a2e39; color: #b2b5be; padding: 12px 10px; cursor: pointer; border-bottom: 2px solid #363a45; white-space: nowrap; }
        td { padding: 12px 10px; border-bottom: 1px solid #2a2e39; }
        tr:hover { background-color: #2a2e39; }
        
        /* Filtri */
        .filter-row th { background: #1e222d; padding: 5px 10px; }
        .filter-input { width: 100%; background: #131722; border: 1px solid #444; color: #fff; font-size: 11px; padding: 5px; border-radius: 3px; box-sizing: border-box; }
        
        /* Segnali */
        .buy { color: #00ff00; font-weight: bold; }
        .sell { color: #ff4444; font-weight: bold; }
        .status-dot { color: #4caf50; margin-right: 5px; }
    </style>
</head>
<body>

    <div class="data-section">
        <div class="header-panel">
            <h2>Moneyline Dashboard <span style="font-size: 12px; color: #888; margin-left: 10px;">Dati Estratti dal Foglio</span></h2>
            <div id="status"><span class="status-dot">‚óè</span>LIVE</div>
        </div>
        
        <div class="table-container">
            <table id="mainTable">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">Ticker</th>
                        <th onclick="sortTable(1)">Prezzo attuale</th>
                        <th onclick="sortTable(2)">Trend W</th>
                        <th onclick="sortTable(3)">Day W</th>
                        <th onclick="sortTable(4)">Var % W</th>
                        <th onclick="sortTable(5)">Trend D</th>
                        <th onclick="sortTable(6)">Day D</th>
                        <th onclick="sortTable(7)">Var % D</th>
                    </tr>
                    <tr class="filter-row">
                        <th><input type="text" class="filter-input" placeholder="Cerca..." onkeyup="filterTable(0)"></th>
                        <th></th> <th><input type="text" class="filter-input" placeholder="BUY/SELL" onkeyup="filterTable(2)"></th>
                        <th><input type="text" class="filter-input" placeholder="Min. giorni" onkeyup="filterTable(3)"></th>
                        <th></th> <th><input type="text" class="filter-input" placeholder="BUY/SELL" onkeyup="filterTable(5)"></th>
                        <th><input type="text" class="filter-input" placeholder="Min. giorni" onkeyup="filterTable(6)"></th>
                        <th></th> </tr>
                </thead>
                <tbody id="tableBody">
                    </tbody>
            </table>
        </div>
    </div>

<script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQdzNpQjqwdqK5ZO16Kd8hlNNtmm31gxOy1AAb49CDXqxMwEOmUpowc9H4rHWPbb9rd874zmOtcDTUo/pub?gid=1410987574&single=true&output=csv';

    async function update() {
        try {
            const res = await fetch(csvUrl + '&t=' + Date.now());
            const text = await res.text();
            const sep = text.includes(';') ? ';' : ',';
            const rows = text.split(/\r?\n/).map(r => r.split(sep));
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            for (let i = 1; i < rows.length; i++) {
                const c = rows[i];
                // Salta righe vuote o senza ticker
                if (!c[0] || c[0].length < 1) continue;

                // Mappatura precisa basata sulle tue istruzioni:
                const ticker = c[0].trim();        // Col A (index 0)
                const trendW = (c[4]||"").trim();  // Col E (index 4)
                const dayW   = c[6] || "";         // Col G (index 6)
                const trendD = (c[8]||"").trim();  // Col I (index 8)
                const dayD   = c[10] || "";        // Col K (index 10)

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:bold; color:#2962ff">${ticker}</td>
                    <td>-</td> <td class="${trendW.toUpperCase().includes('BUY') ? 'buy' : 'sell'}">${trendW}</td>
                    <td>${dayW}</td>
                    <td>-</td> <td class="${trendD.toUpperCase().includes('BUY') ? 'buy' : 'sell'}">${trendD}</td>
                    <td>${dayD}</td>
                    <td>-</td> `;
                tbody.appendChild(tr);
            }
        } catch (e) { 
            console.error("Errore caricamento dati:", e); 
        }
    }

    // Funzione per filtrare la tabella
    window.filterTable = function(n) {
        let input = document.getElementsByClassName("filter-input")[n];
        if(!input) return;
        let filter = input.value.toUpperCase();
        let rows = document.getElementById("tableBody").getElementsByTagName("tr");
        for (let i = 0; i < rows.length; i++) {
            let td = rows[i].getElementsByTagName("td")[n];
            if (td) {
                rows[i].style.display = td.innerText.toUpperCase().includes(filter) ? "" : "none";
            }
        }
    }

    // Funzione per ordinare la tabella
    let sortDirections = {};
    window.sortTable = function(n) {
        let table = document.getElementById("mainTable");
        let tbody = document.getElementById("tableBody");
        let rows = Array.from(tbody.rows);
        
        sortDirections[n] = !sortDirections[n];
        
        rows.sort((a, b) => {
            let x = a.getElementsByTagName("td")[n].innerText.toLowerCase();
            let y = b.getElementsByTagName("td")[n].innerText.toLowerCase();
            
            // Prova a ordinare come numero se possibile
            let xNum = parseFloat(x);
            let yNum = parseFloat(y);
            if (!isNaN(xNum) && !isNaN(yNum)) {
                return sortDirections[n] ? xNum - yNum : yNum - xNum;
            }
            
            return sortDirections[n] ? x.localeCompare(y) : y.localeCompare(x);
        });

        rows.forEach(row => tbody.appendChild(row));
    }

    update();
    setInterval(update, 60000); // Aggiorna ogni minuto
</script>
</body>
</html>
